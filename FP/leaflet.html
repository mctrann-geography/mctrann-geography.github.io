<!DOCTYPE html>

<html>

<head>
    <title>LEAFLET FINAL PROJECT</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://mctrann-geography.github.io/FP/data/caseByDate.js"></script>
    <script src="https://mctrann-geography.github.io/FP/data/sdScoring.js"></script>
    <script src="https://mctrann-geography.github.io/FP/data/county.js"></script>
    <script src="https://mctrann-geography.github.io/FP/data/baseLayer.js"></script>
    <!-- <link href="style/style.css" rel="stylesheet"> -->

</head>
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
#background{
    background: #c7b9b9;

}
    #map {
        min-height: 100%
    }

    .legend {


        padding: 6px 8px;
        line-height: 18px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    /* Optional: adjust the values below to change the appearance of the legend color boxes */

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    .leaflet-container{
    background: #c7b9b9;
}
</style>

<body id = "background">
    <h1>Nebraska Counties and Corona-Virus</h1>
    <div id="map"></div>
    <script type="text/javascript">

        var countyURL = "https://rshepard2.github.io/simpleNEctys.geojson";
        var casesURL = "https://mctrann-geography.github.io/FP/data/caseByDate.geojson";
        var caseHospitalizedURL = "https://mctrann-geography.github.io/FP/data/hospitalizedOfNebraska.geojson";
        var hospitalURL = "https://mctrann-geography.github.io/FP/data/hospitalInfo.json";
        var scoringURL = "https://mctrann-geography.github.io/FP/data/sdScoringF.geojson";

        //INTERACTIVE PARTS

        //FIX STLING SO THAT EVEN IF THE SYMBOL IS COVERING A COUNTY THE COUNTY CAN STILL BE HIGHLIGHTED
        function highlightFeature(e) {
            var layer = e.target;
            // console.log(e.target);
            layer.setStyle({
                color: 'black',
                dashArray: '',
                fillOpacity: 0.7,
                weight: 2.5
            });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            info.update(layer.feature.properties);
        }
        //FIXME: reset style goes over the case symbols
        function resetHighlight(e) {
            basemap.resetStyle(e.target);
            info.update("");
        }
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight
            });
        }

        //chlorpeth map aspect
        function getColor(grade) {
            return grade == "A" ? '#82D976' :
                grade == "B" ? '#C9DD99' :
                    grade == "C" ? '#C9A844' :
                        grade == "D" ? '#CE760A' :
                            grade == "F" ? '#A42727' :
                                '#ccc'
        }

        var map = L.map('map', {
            center: [40.8497493, -100],
            zoom: 7,
            zoomControl: false,
            scrollWheelZoom: false,
            dragging: false,
        });
        map.doubleClickZoom.disable();

        var legend = L.control({ position: 'bottomright' });
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend'),
                grades = ["A", "B", "C", "D", "F", "Not Avaiable"];
            div.innerHTML = '<b>Social Distancing Score<br><br></b>';
            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColor(grades[i]) + '"></i>' +
                    grades[i] + '<br><br>'
            } return div;
        };
        legend.addTo(map);
        //county
        //TODO: UPDATE POLYGON TYPE
        var basemap = L.geoJson(base,
            {
                style: styleScore,
                onEachFeature: onEachFeature
            }).addTo(map);


        var score = L.geoJson(scores, {
            style: styleScore,
            onEachFeature: onEachFeature
        });
        console.log("score loaded.");



        //using jquery
        $.getJSON(casesURL).done(

            function (data) {

                var info = processData(data);
                createPropSymbols(info.timestamps, data);
                // console.log(info.timestamps);
                createSliderUI(info.timestamps);

                console.log("case load");
            }
        );

        function processData(data) {
            var timestamps = [];  // square brackets to define an array of data
            // because there are multiple timestamps
            var min = Infinity; // for the min, begin with the largest possible value - infinity
            var max = -Infinity;// for the max, begin with the smallest possible value - negative infinity

            // Go through each row/feature of the data table
            // Note data is the variable name in the function definition - processData(data)
            for (var feature in data.features) {
                var properties = data.features[feature].properties;
                // console.log(properties);
                // At each row, go through the columns/attributes to get the values
                for (var attribute in properties) {
                    if (attribute != 'county' &&
                        attribute != 'population' &&
                        attribute != 'lat' &&
                        attribute != 'long' &&
                        attribute != 'geometry' &&
                        attribute != 'aggregate' &&
                        attribute != 'tz' &&
                        attribute != 'type')   
                    {
                        if ($.inArray(attribute, timestamps) === -1) { // JQuery in.Array() method searches for a specified value within an array and return its index (or -1 if not found)
                            // here, the new timestamp is only added when it is not already in the array
                            // triple equals === compares both type and value

                            timestamps.push(attribute);  // The JS push() method adds new items to the end of an array
                            // and returns the new length of the array
                        }
                        if (properties[attribute] < min) {
                            min = properties[attribute]; // record/update the current smaller values as the min
                        }
                        if (properties[attribute] > max) {
                            max = properties[attribute]; // record/update the current larger values as the max
                        }
                    }
                }
            }
            return {
                timestamps: timestamps,
                min: min, //1
                max: max
            }
        }
        function createPropSymbols(timestamps, data) {

            casePoint = L.geoJson(data, {

                // By default, Leaflet draws geojson points as simple markers
                // To alter this, the pointToLayer function needs to be used
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, { // we use circle marker for the points
                        fillColor: "#ff0000",  // fill color of the circles
                        color: '#8D021F',      // border color of the circles
                        weight: 2,             // circle line weight in pixels
                        fillOpacity: 0.5       // fill opacity (0-1)
                    }).on({
                        mouseover: function (e) {
                            this.openPopup();
                            this.setStyle({ fillColor: 'green', color: '#8D021F' });  // fill color turns green when mouseover
                        },
                        mouseout: function (e) {
                            this.closePopup();
                            this.setStyle({ fillColor: '#ff0000' });  // fill turns original color when mouseout
                        }
                    });
                }
            }).addTo(map);

            updatePropSymbols(timestamps[0]); //originally LOADS day 1 
            // When loaded, the map will first show proportional symbols with the first timestamp's data
        }
        function createSliderUI(timestamps) {
            var sliderControl = L.control({ position: 'topright' }); // position of the slider
            // Another use of L.control :)
            sliderControl.onAdd = function (map) {
                //initialize a range slider with mousedown control
                var slider = L.DomUtil.create("input", "range-slider");
                L.DomEvent.addListener(slider, 'mousedown', function (e) {
                    L.DomEvent.stopPropagation(e);
                });

                // Define the labels of the time slider as an array of strings
                // Modify this for your data
                var labels = ["March 20", "March 23", " March 31", "April 2", "April 23"];
                //'this' is slider object
                $(slider)
                    .attr({
                        'type': 'range',
                        'max': timestamps[timestamps.length-1], //NEED TO BE VALUES?
                        'min': timestamps[0], //NEED TO BE VALUES?
                        'step': 1, // Change this to match the numeric interval between adjacent timestamps
                        'value': String(timestamps[0])
                    })
                    .on('input change', function () {
                        updatePropSymbols($(this).val().toString()); 
                        var i = $.inArray(this.value, timestamps); //trying to return the slot where date is...BUT VALUE IS NOT DATE SO IT CANT FIND IT?
                        $(".temporal-legend").text(labels[i]); // automatic update the label for the timestamp
                    });
               
                return slider;

            }
            sliderControl.addTo(map);
            createTimeLabel("March 20"); //The starting timestamp label
        }



        function createTimeLabel(startTimestamp) {
            var temporalLegend = L.control({ position: 'topright' }); // same position as the slider
            // One more use of L.control !!
            temporalLegend.onAdd = function (map) {
                var output = L.DomUtil.create("output", "temporal-legend");
                $(output).text(startTimestamp);
                return output;
            }
            temporalLegend.addTo(map);
        }
        // The function to update/resize each circle marker according to a value in the time series
        function updatePropSymbols(timestamp) {
            casePoint.eachLayer(function (layer) {  // eachLayer() is an Leaflet function to iterate over the layers/points of the map

                var props = layer.feature.properties;   // contains each object
                var radius = calcPropRadius(props[timestamp]); // circle radius, calculation function defined below
                // console.log( props); 
                // console.log("VALUE of DAY: " + props[timestamp]); //supposed to call on the date attribute in prop object

                // pop-up information (when mouseover) for each city is also defined here
                // var popupContent = props.county + ': ' + ' cases: ' + String(props[timestamp]);

                layer.setRadius(radius);  // Leaflet method for setting the radius of a circle
                // layer.bindPopup(popupContent, { offset: new L.Point(0, -radius) }); // bind the popup content, with an offset
            });
        }

        // calculate the radius of the proportional symbols based on area
        function calcPropRadius(attributeValue) {

            var scaleFactor = 20;   // the scale factor is used to scale the values; the units of the radius are in meters
            // you may determine the scale factor accordingly based on the range of the values and the mapping scale
            var area = attributeValue * scaleFactor;

            return Math.sqrt(area / Math.PI);  // the function return the radius of the circle to be used in the updatePropSymbols()
        }
        //POPUP on side    
        var info = L.control({ position: 'bottomleft' });
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        info.update = function (props) {

            this._div.innerHTML = '<h1>County Info<h1>' + (props ?
                '<p><b> County Name: ' + props.NAME10 + '</b> <br />' + ' Social Distance Score:  ' + props.grade_total + "<br /> " + props.Sum_BEDCT + ' hospital beds </p>'
                : '');
            // console.log(props);
        };
        info.addTo(map);


        function styleScore(feature) {
            return {
                fillColor: getColor(feature.properties.grade_distance),
                weight: 2,
                opacity: 1,
                color: 'gray',
                fillOpacity: 0.9
            };
        }
        function styleBase(feature) {
            return {
                fillColor: 'gray',
                weight: 2,
                opacity: 1,
                color: 'gray',
                fillOpacity: 0.9
            };
        }

//TIP: open refine for converting geojson --> csv
    </script>
</body>

</html>