<!DOCTYPE html>

<html>

<head>
    <title>LEAFLET FINAL PROJECT</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<style>
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #map {
        min-height: 100%
    }

    .legend {
        padding: 6px 8px;
        line-height: 18px;
        background: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
    }

    /* Optional: adjust the values below to change the appearance of the legend color boxes */

    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>

<body>
    <h1>Nebraska Counties and Corona-Virus</h1>
    <div id="map"></div>
    <script type="text/javascript">

        var countyURL = "https://rshepard2.github.io/simpleNEctys.geojson";
        var casesURL = "https://mctrann-geography.github.io/FP/data/caseByDate.geojson";
        var caseHospitalizedURL = "https://mctrann-geography.github.io/FP/data/hospitalizedOfNebraska.geojson";
        var hospitalURL = "https://mctrann-geography.github.io/FP/data/hospitalInfo.json";
        var scoringURL = "https://mctrann-geography.github.io/FP/data/sdScoringF.geojson";

        //INTERACTIVE PARTS
        function highlightFeature(e) {
            var layer = e.target;
            // console.log(e.target);
            layer.setStyle({
                color: 'black',
                dashArray: '',
                fillOpacity: 0.7,
                weight: 2.5
            });
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
            info.update(layer.feature.properties);
        }
        function resetHighlight(e) {
            basemap.resetStyle(e.target);
            score.resetStyle(e.target);
            info.update("");
        }
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight
            });
        }

        //chlorpeth map aspect
        function getColor(grade) {
            return grade == "A" ? '#82D976' :
                grade == "B" ? '#C9DD99' :
                    grade == "C" ? '#C9A844' :
                        grade == "D" ? '#CE760A' :
                            grade == "F" ? '#A42727' :
                                '#ccc'
        }

        // function assignStyle(currentStyle, newStyle) {
        //     currentStyle.setStyle(newStyle);
        //     currentStyle._recordedStyle = newStyle;
        // }

        // function reassignStyle(oldStyle) {
        //     oldStyle.setStyle(oldStyle._recordedStyle);
        // }

        var map = L.map('map', {
            center: [40.8497493, -100],
            zoom: 7,
            zoomControl: false,
            scrollWheelZoom: false,
            dragging: false,
        });
        map.doubleClickZoom.disable(); 
        //import base map with JQUERY
        var basemap;

        $.getJSON(countyURL).done(
            function (data) {
                basemap = L.geoJson(data,
                    {
                        style: styleBase,
                        onEachFeature: onEachFeature
                        // assignStyle()
                    }).addTo(map);
            }
        )

        //scoring
        //TODO: how to integrate hover for both county & score layer?
        //TODO: how to set default style to custom style layers? 
        //issue: missing some counties --> unacast does not have all data default to grey
        var score;
        $.getJSON(scoringURL).done(
            function (data) {
                score = L.geoJson(data,
                    {
                        style: styleScore,
                        onEachFeature: onEachFeature
                    }).addTo(map);
                console.log("score load");
            }
        )

        //CASES
        //TODO: FIX ERROR & SLIDER
        //import cases

        $.getJSON(casesURL).done(

            function (data) {

                var info = processData(data);
                createPropSymbols(info.timestamps, data);
                createSliderUI(info.timestamps);

                // cases = L.geoJson(data,
                //     {
                //         // style: styleBase,
                //         onEachFeature: onEachFeature,
                //         pointToLayer: function (feature, latlang) {
                //             return L.circleMarker(latlang, {
                //                 color: '#000000',
                //                 opacity: 1,
                //                 weight: 2,
                //                 fillColor: '#ffff8c',
                //                 fillOpacity: .5,
                //                 radius: calcRadius(feature.properties) //TODO: properties.{date}??
                //             }
                //     }); //ADD TO MAP LATER?
                console.log("case load");
            }
        );
        function processData(data) {
            // First, initialize the variables to hold the timestamps and min/max population values
            var timestamps = [];  // square brackets to define an array of data
            // because there are multiple timestamps
            var min = Infinity; // for the min, begin with the largest possible value - infinity
            var max = -Infinity;// for the max, begin with the smallest possible value - negative infinity

            // Go through each row/feature of the data table
            // Note data is the variable name in the function definition - processData(data)
            for (var feature in data.features) {
                var properties = data.features[feature].properties;

                // At each row, go through the columns/attributes to get the values
                for (var attribute in properties) {
                    if (attribute != 'county' &&
                        attribute != 'population' &&
                        attribute != 'lat' &&
                        attribute != 'long' &&
                        attribute != 'aggregate' &&
                        attribute != 'tz' &&
                        attribute != 'type')   // != means NOT EQUAL TO
                    // These three columns are NOT recorded
                    // Modify this part when mapping your own data
                    {
                        if ($.inArray(attribute, timestamps) === -1) { // JQuery in.Array() method searches for a specified value within an array and return its index (or -1 if not found)
                            // here, the new timestamp is only added when it is not already in the array
                            // triple equals === compares both type and value

                            timestamps.push(attribute);  // The JS push() method adds new items to the end of an array
                            // and returns the new length of the array
                        }
                        if (properties[attribute] < min) {
                            min = properties[attribute]; // record/update the current smaller values as the min
                        }
                        if (properties[attribute] > max) {
                            max = properties[attribute]; // record/update the current larger values as the max
                        }
                    }
                }
            }
            return {
                timestamps: timestamps,
                min: min,
                max: max
            }
        }
        function createPropSymbols(timestamps, data) {

            casePoint = L.geoJson(data, {

                // By default, Leaflet draws geojson points as simple markers
                // To alter this, the pointToLayer function needs to be used
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, { // we use circle marker for the points
                        fillColor: "#ff0000",  // fill color of the circles
                        color: '#8D021F',      // border color of the circles
                        weight: 2,             // circle line weight in pixels
                        fillOpacity: 0.5       // fill opacity (0-1)
                    }).on({
                        mouseover: function (e) {
                            this.openPopup();
                            this.setStyle({ fillColor: 'green', color: '#8D021F' });  // fill color turns green when mouseover
                        },
                        mouseout: function (e) {
                            this.closePopup();
                            this.setStyle({ fillColor: '#ff0000' });  // fill turns original color when mouseout
                        }
                    });
                }
            }).addTo(map);

            updatePropSymbols(timestamps[0]); // this function is defined below
            // When loaded, the map will first show proportional symbols with the first timestamp's data
        }
        function createSliderUI(timestamps) {
            var sliderControl = L.control({ position: 'topright' }); // position of the slider
            // Another use of L.control :)
            sliderControl.onAdd = function (map) {
                //initialize a range slider with mousedown control
                var slider = L.DomUtil.create("input", "range-slider");
                L.DomEvent.addListener(slider, 'mousedown', function (e) {
                    L.DomEvent.stopPropagation(e);
                });

                // Define the labels of the time slider as an array of strings
                // Modify this for your data
                var labels = ["3-20", "3-23", "3-31", "4-2", "4-23"];

                $(slider)
                    .attr({
                        'type': 'range',
                        'max': timestamps[timestamps.length - 1],
                        'min': timestamps[0],
                        'step': 1, // Change this to match the numeric interval between adjacent timestamps
                        'value': String(timestamps[0])
                    })
                    .on('input change', function () {
                        updatePropSymbols($(this).val().toString()); // automatic update the map for the timestamp
                        var i = $.inArray(this.value, timestamps);
                        $(".temporal-legend").text(labels[i]); // automatic update the label for the timestamp
                    });
                return slider;
            }
            sliderControl.addTo(map);
            createTimeLabel("3-20"); //The starting timestamp label
        }



        function createTimeLabel(startTimestamp) {
            var temporalLegend = L.control({ position: 'topleft' }); // same position as the slider
            // One more use of L.control !!
            temporalLegend.onAdd = function (map) {
                var output = L.DomUtil.create("output", "temporal-legend");
                $(output).text(startTimestamp);
                return output;
            }
            temporalLegend.addTo(map);
        }
        // The function to update/resize each circle marker according to a value in the time series
        function updatePropSymbols(timestamp) {

            casePoint.eachLayer(function (layer) {  // eachLayer() is an Leaflet function to iterate over the layers/points of the map

                var props = layer.feature.properties;   // attributes
                var radius = calcPropRadius(props[timestamp]); // circle radius, calculation function defined below

                // pop-up information (when mouseover) for each city is also defined here
                var popupContent = props.county + ': ' + timestamp + ' cases: ' + String(props[timestamp]);

                layer.setRadius(radius);  // Leaflet method for setting the radius of a circle
                layer.bindPopup(popupContent, { offset: new L.Point(0, -radius) }); // bind the popup content, with an offset
            });
        }

        // calculate the radius of the proportional symbols based on area
        function calcPropRadius(attributeValue) {

            var scaleFactor = 0.5;   // the scale factor is used to scale the values; the units of the radius are in meters
            // you may determine the scale factor accordingly based on the range of the values and the mapping scale
            var area = attributeValue * scaleFactor;

            return Math.sqrt(area / Math.PI);  // the function return the radius of the circle to be used in the updatePropSymbols()
        }
        //POPUP on side    
        var info = L.control();
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;
        };

        info.update = function (props) {
            // this._div.innerHTML = '<h4>China/[insert chinese characters] </h4>' +  (props ?
            //   '<b>' + props.NAME_PY + '</b><br />' props.Deaths + ' death(s)' : '');
            this._div.innerHTML = '<h3>County Info</h3>' + (props ?
                '<b>' + props.county_name + '</b><br /> ' + 'Social Distance Score: ' + props.grade_distance
                : '');
            console.log(props);
        };
        info.addTo(map);

        //FIXME: GEOJSON IS NOT UPLODAINGF??s?f/JOSAL/DKFJAOI'FJAO'ESKFJLKM
        // var basemap = $.ajax({
        //     url: countyURL,
        //     dataType: "json",
        //     success: console.log ("County data successfully loaded."),
        //     error: function(xhr){
        //         alert('COUNTIES NOT UPLOADED, you can cry now');
        //     }
        // });
        // $.when(basemap).done(function(){
        //     var map = L.map('map', {
        //             center: [40.8497493, -100],
        //             zoom: 7,
        //             zoomControl: false,
        //             scrollWheelZoom: false,
        //             dragging: false,
        //         }).setView([40.8497493, -100],7);

        //     var counties = L.geoJSON(counties.responseJSON, {
        //         style: style,
        //         onEachFeature: onEachFeature
        //     }).addTo(map);
        // })
        function styleScore(feature) {
            return {
                fillColor: getColor(feature.properties.grade_distance),
                weight: 2,
                opacity: 1,
                color: 'gray',
                fillOpacity: 0.9
            };
        }
        function styleBase(feature) {
            return {
                fillColor: 'gray',
                weight: 2,
                opacity: 1,
                color: 'gray',
                fillOpacity: 0.9
            };
        }


    </script>
</body>

</html>